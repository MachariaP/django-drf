# Render Deployment Fix Guide

## Problem

The Django application was failing to deploy on Render with the following issues:

1. **Database Connection Failure**: The application couldn't connect to the PostgreSQL database after 30 attempts (60 seconds)
2. **Gunicorn Not Starting**: The Docker container wasn't starting the Gunicorn server
3. **Static Files Error**: The collectstatic command was failing due to missing directories

## Root Causes

### 1. Dockerfile CMD/ENTRYPOINT Issue

**Problem**: The Dockerfile had:
```dockerfile
CMD ["/app/docker-entrypoint.sh"]
```

The entrypoint script ends with `exec "$@"`, which expects command arguments to be passed. Without arguments, Gunicorn never started.

**Fix**: Changed to use proper ENTRYPOINT and CMD:
```dockerfile
ENTRYPOINT ["/app/docker-entrypoint.sh"]
CMD ["gunicorn", "config.wsgi:application", "--config", "gunicorn_config.py"]
```

### 2. Database URL Format

**Problem**: The connection logic only checked for `postgresql://` but Render uses `postgres://` format.

**Fix**: Updated the database connection parsing to handle both formats:
```python
# Normalize postgres:// to postgresql://
conn_str = conn_str.replace('postgres://', 'postgresql://', 1)
```

### 3. Static Files Directory

**Problem**: The settings.py referenced a non-existent `static/` directory in STATICFILES_DIRS.

**Fix**: Made the directory conditional:
```python
static_dir = os.path.join(BASE_DIR, 'static')
STATICFILES_DIRS = [static_dir] if os.path.exists(static_dir) else []
```

### 4. Health Check Path

**Problem**: The render.yaml had `healthCheckPath: /api/` which doesn't exist.

**Fix**: Updated to use the actual health endpoint:
```yaml
healthCheckPath: /api/health/
```

## Deployment Steps

### 1. Set Up Render

1. **Create a PostgreSQL Database** on Render:
   - Go to Render Dashboard > New > PostgreSQL
   - Name: `django-drf-db`
   - Plan: Free (or choose your plan)
   - Wait for database to be created

2. **Create a Web Service**:
   - Go to Render Dashboard > New > Web Service
   - Connect your GitHub repository
   - Choose the branch with these fixes
   - Render will automatically detect the `render.yaml` file

### 2. Configure Environment Variables

The following environment variables are automatically configured via `render.yaml`:

- ‚úÖ `DATABASE_URL` - Auto-configured from the database
- ‚úÖ `SECRET_KEY` - Auto-generated by Render
- ‚úÖ `DEBUG` - Set to "False"
- ‚úÖ `DJANGO_SUPERUSER_USERNAME` - Set to "admin"
- ‚úÖ `DJANGO_SUPERUSER_EMAIL` - Set to "admin@example.com"
- ‚ö†Ô∏è `DJANGO_SUPERUSER_PASSWORD` - **Must be set manually!**

**Important**: You must manually set `DJANGO_SUPERUSER_PASSWORD` in the Render dashboard:

1. Go to your web service > Environment
2. Add/Edit the `DJANGO_SUPERUSER_PASSWORD` variable
3. Set a strong password
4. Save changes

### 3. Optional: Redis Cache

If you want to use Redis caching:

1. Create a Redis instance on Render
2. Add the `REDIS_URL` environment variable to your web service
3. The application will automatically use Redis if `REDIS_URL` is set

### 4. Deploy

1. Push your code to GitHub
2. Render will automatically deploy (if autoDeploy is enabled)
3. Monitor the deployment logs

## Deployment Logs Explained

You should see the following in your deployment logs:

```
üöÄ Starting Django application...
‚è≥ Waiting for database to be ready...
Connecting to <render-hostname>:5432/<dbname> as <user>...
‚úÖ Database is ready!
üì¶ Running database migrations...
üë§ Creating superuser...
üìÅ Collecting static files...
‚úÖ Initialization complete!
üåê Starting Gunicorn server...
```

## Troubleshooting

### Database Connection Fails

If you see "Database not ready yet" messages looping:

1. **Check DATABASE_URL**: Make sure it's properly set in Render environment variables
2. **Check Database Status**: Ensure the PostgreSQL database is running in Render dashboard
3. **Check Region**: Database and web service should be in the same region for best connectivity
4. **Check Logs**: Look for specific error messages in the Python output

### Gunicorn Fails to Start

1. **Check Logs**: Look for Python errors during migrations or collectstatic
2. **Check Settings**: Ensure SECRET_KEY is set
3. **Check Static Files**: Verify collectstatic completed successfully

### Health Check Fails

1. **Check Endpoint**: Verify `/api/health/` is accessible
2. **Check Database**: Health check tests database connectivity
3. **Check Logs**: Look for Django errors in startup

### Superuser Not Created

If the superuser isn't created:

1. **Check Environment Variables**: Ensure both `DJANGO_SUPERUSER_USERNAME` and `DJANGO_SUPERUSER_PASSWORD` are set
2. **Check Logs**: Look for superuser creation messages
3. **Manual Creation**: You can manually create via Django shell:
   ```bash
   # In Render shell
   python manage.py createsuperuser
   ```

## Local Testing

To test the Docker setup locally:

```bash
# Build the image
docker build -t django-drf .

# Run with environment variables
docker run -p 8000:8000 \
  -e DATABASE_URL="postgres://user:pass@host:5432/dbname" \
  -e SECRET_KEY="your-secret-key" \
  -e DEBUG="False" \
  -e DJANGO_SUPERUSER_USERNAME="admin" \
  -e DJANGO_SUPERUSER_PASSWORD="admin123" \
  -e DJANGO_SUPERUSER_EMAIL="admin@example.com" \
  django-drf
```

## Changes Summary

### Files Modified

1. **Dockerfile**
   - Changed CMD to ENTRYPOINT/CMD pattern
   - Now properly starts Gunicorn after initialization

2. **scripts/docker-entrypoint.sh**
   - Enhanced database URL parsing
   - Added support for both `postgres://` and `postgresql://` formats
   - Added better error logging
   - Added automatic superuser creation
   - Made port number optional (defaults to 5432)

3. **django-api/config/settings.py**
   - Made STATICFILES_DIRS conditional
   - Only includes static directory if it exists

4. **render.yaml**
   - Fixed health check path to `/api/health/`

## Next Steps

After successful deployment:

1. ‚úÖ Access your API at `https://<your-service>.onrender.com/api/`
2. ‚úÖ View API documentation at `https://<your-service>.onrender.com/api/docs/`
3. ‚úÖ Access admin panel at `https://<your-service>.onrender.com/admin/`
4. ‚úÖ Test health endpoint at `https://<your-service>.onrender.com/api/health/`

## Security Notes

- ‚ö†Ô∏è Never commit `.env` files with real credentials
- ‚úÖ Use Render's environment variables for sensitive data
- ‚úÖ Keep `DEBUG=False` in production
- ‚úÖ Use strong passwords for superuser accounts
- ‚úÖ Regularly update dependencies for security patches

## Support

If you continue to experience issues:

1. Check Render's status page for platform issues
2. Review deployment logs carefully
3. Verify all environment variables are set correctly
4. Ensure database and web service are in the same region
5. Contact Render support if database connectivity issues persist
